<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>AR (robust + local libs)</title>

  <!-- ローカル配信（CDN不調切り分け） -->
<script src="./libs/aframe.min.js"></script>
<script src="./libs/mindar-image-aframe.prod.js"></script>


  <style>
    html,body{margin:0;height:100%;background:#000} body{overflow:hidden}
    .ui{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
    .panel{background:rgba(0,0,0,.65);color:#fff;padding:14px 16px;border-radius:12px;
           font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;text-align:center}
    button{margin-top:10px;padding:10px 14px;border:0;border-radius:10px;background:#00c389;color:#10231b;font-weight:700}
    .toast{position:fixed;left:12px;right:12px;bottom:12px;color:#fff;background:rgba(0,0,0,.55);
           padding:8px 10px;border-radius:10px;font:13px/1.4 system-ui;display:none;white-space:pre-wrap}
  </style>
</head>
<body>
  <!-- 初回はユーザー操作で開始（iOS安定化） -->
  <div id="gate" class="ui">
    <div class="panel">
      <div style="font-weight:700;margin-bottom:6px">カメラを開始します</div>
      <div>Safari/Chromeで開いてください（LINE/Xアプリ内は不可の場合あり）。</div>
      <button id="startBtn">はじめる</button>
    </div>
  </div>
  <div id="toast" class="toast"></div>

  <a-scene id="sc"
    mindar-image="imageTargetSrc: ./targets.mind; autoStart: false;"
    color-space="sRGB"
    renderer="precision: mediump; antialias: true; physicallyCorrectLights: true"
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:true"
    embedded
  >
    <a-camera look-controls="enabled:false"></a-camera>

    <a-entity mindar-image-target="targetIndex:0">
      <a-entity gltf-model="./model.glb" position="0 0 0.05" scale="0.15 0.15 0.15" animation-mixer></a-entity>
    </a-entity>

    <a-entity light="type: ambient; intensity:0.9"></a-entity>
    <a-entity light="type: directional; intensity:0.6" position="1 1 1"></a-entity>
  </a-scene>

  <script>
  (function(){
    const sc = document.getElementById('sc');
    const gate = document.getElementById('gate');
    const toast = document.getElementById('toast');
    const show = (m)=>{ toast.textContent=m; toast.style.display='block'; clearTimeout(show._t); show._t=setTimeout(()=>toast.style.display='none', 3500); };

    function waitSceneLoaded(el){
      return new Promise(res => el.hasLoaded ? res() : el.addEventListener('loaded', res, {once:true}));
    }

    // 参考：状態メッセージ
    sc.addEventListener('arReady', ()=>show('カメラ開始。ターゲットにかざしてください'));
    sc.addEventListener('arError', ()=>show('カメラ/センサーが利用できません。権限とHTTPSを確認'));

    document.getElementById('startBtn').addEventListener('click', async ()=>{
      try{
        // ① 先に権限だけ確実に取る
        const s = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment' } }, audio:false });
        s.getTracks().forEach(t=>t.stop());

        // ② A-Frameシーンの初期化完了を待つ
        await waitSceneLoaded(sc);

        // ③ プラグイン読み込み検証
        const compOK = !!(window.AFRAME && AFRAME.components && AFRAME.components['mindar-image-target']);
        if (!compOK){ show('MindARスクリプトが読み込まれていません（./libs/ のパスを確認）'); return; }

        // ④ mindar-image-system を取得して開始
        const sys = sc.systems && sc.systems['mindar-image-system'];
        if (!sys){ show('初期化未完了：再読み込みしても改善しない場合は端末のブラウザを変えてください'); return; }

        await sys.start();
        gate.style.display='none';
        show('起動しました');
      }catch(e){
        show(`起動エラー:\n${e.name||''} ${e.message||e}`);
      }
    }, {passive:true});
  })();
  </script>
</body>
</html>
